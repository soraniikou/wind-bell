<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gently Wind Bell</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* スクロール防止 */
            background-color: #0a0f1e;
        }

        /* 画像にあったCSS要素を統合 */
        canvas {
            position: fixed;
            inset: 0;
            z-index: 10;
            display: block;
        }

        /* 風鈴の紐のような装飾（必要に応じて） */
        .bell-string {
            position: absolute;
            top: 0;
            width: 1px;
            height: 80px;
            background: linear-gradient(180deg, rgba(200,220,255,0.5), transparent);
            z-index: 5;
            pointer-events: none;
        }
    </style>
</head>
<body>

<script>
let particles = [];
let msgAlpha = 255;

function setup() {
    createCanvas(windowWidth, windowHeight);
    background(10, 15, 30);
    // 音の開始にはユーザーの操作が必要なため、ここで一度オーディオコンテキストを準備
    userStartAudio();
}

function draw() {
    // 残像演出
    background(10, 15, 30, 25); 

    // メッセージ表示
    if (msgAlpha > 0) {
        fill(200, 220, 255, msgAlpha);
        textAlign(CENTER, CENTER);
        noStroke();
        textSize(20);
        text("Press gently", width / 2, height / 2);
        
        if (mouseIsPressed || (touches && touches.length > 0)) {
            msgAlpha -= 5;
        }
    }

    // 星屑の更新と描画
    for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        particles[i].display();
        if (particles[i].isDead()) {
            particles.splice(i, 1);
        }
    }
}

// マウス移動・タッチ時の処理
function mouseMoved() {
    handleInteraction(mouseX, mouseY);
}

function touchMoved() {
    if (touches.length > 0) {
        handleInteraction(touches[0].x, touches[0].y);
    }
    return false; // スクロール防止
}

function handleInteraction(x, y) {
    if (random() > 0.8) {
        playSlowWindBell(x);
        for (let i = 0; i < 3; i++) {
            particles.push(new StarDust(x, y));
        }
    }
}

// --- 長い余韻の音を鳴らす関数 ---
function playSlowWindBell(x) {
    let osc = new p5.Oscillator('sine');
    let env = new p5.Envelope();
    
    // release(余韻)を 8.0 秒に設定して長く響かせます
    env.setADSR(0.2, 1.0, 0.1, 8.0);
    env.setRange(0.1, 0);

    // 左右に音を振る（パン）を追加して広がりを出す
    let panValue = map(x, 0, width, -1, 1);
    osc.pan(panValue);

    let freq = map(x, 0, width, 1200, 3000) + random(-50, 50);
    osc.freq(freq);
    osc.amp(env);
    osc.start();
    env.play();

    // 10秒後にリソース解放
    setTimeout(() => osc.stop(), 10000);
}

// --- 星屑のクラス ---
class StarDust {
    constructor(x, y) {
        this.pos = createVector(x, y);
        this.vel = p5.Vector.random2D().mult(random(0.2, 1.0));
        this.acc = createVector(0, 0.01);
        this.lifespan = 255;
        // 優しい青と黄色の混合
        this.color = random() > 0.5 ? color(200, 230, 255) : color(255, 250, 200);
        this.size = random(1, 3);
    }

    update() {
        // 思考がゆらぐような微細な動き
        this.pos.x += sin(frameCount * 0.05 + this.lifespan) * 0.3;
        this.vel.add(this.acc);
        this.pos.add(this.vel);
        this.lifespan -= 1.2; // 少しゆっくり消えるように調整
    }

    display() {
        noStroke();
        let a = map(this.lifespan, 0, 255, 0, 180);
        fill(red(this.color), green(this.color), blue(this.color), a);
        let sz = this.size * (sin(frameCount * 0.1) + 1.2);
        circle(this.pos.x, this.pos.y, sz);
    }

    isDead() { return this.lifespan < 0; }
}

// ウィンドウサイズ変更対応
function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
